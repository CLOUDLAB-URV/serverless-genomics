# Dockerfile for genomics use case variant caller lambda function
# command: lithops runtime build -f Dockerfile -b aws_lambda lumimar/hutton-genomics-v03:03
# Include global arg in this stage of the build
ARG FUNCTION_DIR="/function"
ARG BINS_DIR="/function/bin"
FROM python:3.8-buster as build-image
ARG FUNCTION_DIR
ARG BINS_DIR
# Install aws-lambda-cpp build dependencies
RUN apt-get update && \
  apt-get install -y \
    g++ \
    gcc \
    make \
    cmake \
    autoconf \
    automake \
    unzip \
    zip \
    perl \
    wget \
    libssl-dev \
    libncurses5-dev \
    zlib1g-dev \
    libxslt-dev \
    libxml2-dev \
    zlib1g-dev \
    libbz2-dev 

# Create function work directories
RUN mkdir -p ${FUNCTION_DIR}
RUN mkdir -p ${BINS_DIR}
# Compile gem-mapper
RUN git clone --recursive https://github.com/smarco/gem3-mapper.git \
    && cd gem3-mapper \
    && sh configure \
    && make \
    && cd .. \
    && mv gem3-mapper/bin/* ${BINS_DIR}
# Compile samtools
RUN wget https://github.com/samtools/samtools/releases/download/1.15/samtools-1.15.tar.bz2 -O samtools.tar.bz2 \
    && tar -xjvf samtools.tar.bz2 \
    && cd samtools-1.15 \
    && ./configure prefix=${FUNCTION_DIR} \
    && make \
    && make install \
    && cd ..
# Download, compile and install gztool
RUN wget https://github.com/circulosmeos/gztool/archive/refs/tags/v1.4.2.zip \
    && unzip v1.4.2.zip \
    && cd gztool-1.4.2 \
    && gcc -O3 -o gztool gztool.c -lz -lm \
    && cp gztool ${BINS_DIR}
# Download, compile and install fastq-dump
RUN wget https://ftp-trace.ncbi.nlm.nih.gov/sra/sdk/3.0.0/sratoolkit.3.0.0-ubuntu64.tar.gz \
	&& tar zxvf sratoolkit.3.0.0-ubuntu64.tar.gz  \
    && cd /sratoolkit.3.0.0-ubuntu64/bin \
    && mv * ${BINS_DIR}

#Install dependencies for fastq-dump
RUN apt-get update  \
    && apt-get --quiet install --yes libxml-libxml-perl
# Add sinple
COPY SiNPle-0.5 ${BINS_DIR}/SiNPle-0.5
COPY com ${BINS_DIR}/com
# Update pip
RUN pip install -U pip wheel setuptools
# Install the function's dependencies
RUN pip install \
    --target ${FUNCTION_DIR} \
        awslambdaric \
        boto3 \
        redis \
        httplib2 \
        requests \
        numpy \
        scipy \
        pandas \
        pika \
        kafka-python \
        cloudpickle \
        ps-mem \
        tblib \
        pyarrow \
        fastparquet
# Add mpileup merge script
COPY mpileup_merge_reducev3.sh ${BINS_DIR}/mpileup_merge_reducev3.sh
COPY mpileup_merge_reducev3_nosinple.sh ${BINS_DIR}/mpileup_merge_reducev3_nosinple.sh
COPY parse_gem_maxindex_minimapfile_stdin_v2.sh ${BINS_DIR}/parse_gem_maxindex_minimapfile_stdin_v2.sh
COPY map_index_and_filter_map_file_cmd_awsruntime.sh ${BINS_DIR}/map_index_and_filter_map_file_cmd_awsruntime.sh
COPY map_file_index_correction.sh ${BINS_DIR}/map_file_index_correction.sh
COPY gempileup_v7.sh ${BINS_DIR}/gempileup_v7.sh
COPY gempileup_merge.sh ${BINS_DIR}/gempileup_merge.sh
COPY gempileup_run.sh ${BINS_DIR}/gempileup_run.sh
# Add Lithops
COPY lithops_lambda.zip ${FUNCTION_DIR}
RUN cd ${FUNCTION_DIR} \
    && unzip lithops_lambda.zip \
    && rm lithops_lambda.zip \
    && mkdir handler \
    && touch handler/__init__.py \
    && mv entry_point.py handler/ \
    && cd
FROM python:3.8-buster
# Include global arg in this stage of the build
ARG FUNCTION_DIR
ARG BINS_DIR
# Copy in the built dependencies
COPY --from=build-image ${FUNCTION_DIR} ${FUNCTION_DIR}
RUN apt update && apt install \
    gawk \
    && rm -rf /var/lib/apt/lists/* \
    && apt-cache search linux-headers-generic
# Set working directory to function root directory
WORKDIR ${FUNCTION_DIR}
# Update permissions for binaries and append location to PATH
RUN chmod -R ugoa+rwx ${BINS_DIR}
ENV PATH="${BINS_DIR}:${PATH}"
ENTRYPOINT [ "/usr/local/bin/python", "-m", "awslambdaric" ]
CMD [ "handler.entry_point.lambda_handler" ]